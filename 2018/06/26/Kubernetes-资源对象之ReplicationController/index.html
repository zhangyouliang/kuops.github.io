<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Kubernetes-资源对象之ReplicationController"><meta name="keywords" content=""><meta name="author" content="kuops,undefined"><meta name="copyright" content="kuops"><title>Kubernetes-资源对象之ReplicationController | Kuops Blog</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.4"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  localSearch: undefined
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ReplicationController"><span class="toc-number">1.</span> <span class="toc-text">ReplicationController</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编写-ReplicationController-Spec"><span class="toc-number">2.</span> <span class="toc-text">编写 ReplicationController Spec</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Pod-Template"><span class="toc-number">2.1.</span> <span class="toc-text">Pod Template</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Label"><span class="toc-number">2.2.</span> <span class="toc-text">Label</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pod-Selector"><span class="toc-number">2.3.</span> <span class="toc-text">Pod Selector</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Replicas"><span class="toc-number">2.4.</span> <span class="toc-text">Replicas</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用-ReplicationController"><span class="toc-number">3.</span> <span class="toc-text">使用 ReplicationController</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建-Pod"><span class="toc-number">3.1.</span> <span class="toc-text">创建 Pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除-ReplicationController-和-Pod"><span class="toc-number">3.2.</span> <span class="toc-text">删除 ReplicationController 和 Pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#只删除-ReplicationController"><span class="toc-number">3.3.</span> <span class="toc-text">只删除 ReplicationController</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重新调度"><span class="toc-number">3.4.</span> <span class="toc-text">重新调度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#扩容与缩容"><span class="toc-number">3.5.</span> <span class="toc-text">扩容与缩容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#滚动更新"><span class="toc-number">3.6.</span> <span class="toc-text">滚动更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#多版本跟踪"><span class="toc-number">3.7.</span> <span class="toc-text">多版本跟踪</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-ReplicationControllers-与-Services"><span class="toc-number">3.8.</span> <span class="toc-text">使用 ReplicationControllers 与 Services</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#replication-的替代品"><span class="toc-number">4.</span> <span class="toc-text">replication 的替代品</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ReplicaSet"><span class="toc-number">4.1.</span> <span class="toc-text">ReplicaSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deployment（推荐）"><span class="toc-number">4.2.</span> <span class="toc-text">Deployment（推荐）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Job"><span class="toc-number">4.3.</span> <span class="toc-text">Job</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DaemonSet"><span class="toc-number">4.4.</span> <span class="toc-text">DaemonSet</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">kuops</div><div class="author-info__description text-center">巧者劳而智者忧，无能者无所求</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">36</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">5</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1529517901642&amp;di=5f7db410ab487b78dd0afc85bc246702&amp;imgtype=0&amp;src=http%3A%2F%2Fimg5.duitang.com%2Fuploads%2Fitem%2F201610%2F21%2F20161021234613_KvFXP.jpeg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Kuops Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">Kubernetes-资源对象之ReplicationController</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-06-26</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/kubernetes/">kubernetes</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div id="post-content"><h2 id="ReplicationController"><a href="#ReplicationController" class="headerlink" title="ReplicationController"></a>ReplicationController</h2><p>ReplicationController 是 Pod 控制器的一种，一般而言，Pod 不会去直接定义，而是通过控制器去创建，可以帮助控制 Pod 总是以期望的结果运行。与手动创建的 pod 不同，由 ReplicationController 维护的 pod 在失败，被删除或终止时会自动替换。</p>
<p>例如，在进行破坏性维护（例如内核升级）之后，您的 Pod 将在节点上重新创建。因此，即使您的应用程序只需要一个 Pod，也应该使用 ReplicationController。ReplicationController 类似于进程管理器，但不是监督单个节点上的单个进程，而是通过 ReplicationController 监控多个节点上的多个进程。</p>
<p>在平常谈论中，ReplicationController 通常缩写为 <code>rc</code> 或 <code>rcs</code> ，并且作为 kubectl 命令的快捷方式。</p>
<p>一个简单的例子是创建一个 ReplicationController 对象，以无限期可靠地运行 Pod 的一个实例。更复杂的用例是运行复制服务的多个相同副本，例如 Web 服务器。</p>
<h2 id="编写-ReplicationController-Spec"><a href="#编写-ReplicationController-Spec" class="headerlink" title="编写 ReplicationController Spec"></a>编写 ReplicationController Spec</h2><p>与其他 Kubernetes 配置一样，ReplicationController 需要 <code>apiVersion</code>、 <code>kind</code> 和 <code>metadata</code> 字段，不同的是 ReplicationController 还需要一个 <code>.spec</code> 部分。</p>
<h3 id="Pod-Template"><a href="#Pod-Template" class="headerlink" title="Pod Template"></a>Pod Template</h3><p>这 <code>.spec.template</code> 是 <code>.spec</code> 中的必须字段，<code>.spec.template</code> 是一个pod模板。它与pod的样式完全相同，除了它是嵌套的，并且没有 apiVersion 和 kind。除了 Pod 的必需字段外，ReplicationController 中的pod 模板还必须指定适当的标签和适当的重新启动策略。对于标签，请确保不要与其他控制器重叠。</p>
<p><code>.spec.template.spec.restartPolicy</code> 只允许等于 <code>Always</code>，如果未指定，则为默认值。</p>
<p>对于本地容器重新启动，ReplicationController委托给节点上的代理，例如 Kubelet 或 Docker 。</p>
<h3 id="Label"><a href="#Label" class="headerlink" title="Label"></a>Label</h3><p>ReplicationController 本身可以有标签 (<code>.metadata.labels</code>）。通常情况下，你可以将它们设置为相同的 <code>.spec.template.metadata.labels</code>; 如果 <code>.metadata.labels</code> 未指定，则默认为 <code>.spec.template.metadata.labels</code>。但是，它们可以不同，并且 <code>.metadata.labels</code>不会影响ReplicationController 的行为。</p>
<h3 id="Pod-Selector"><a href="#Pod-Selector" class="headerlink" title="Pod Selector"></a>Pod Selector</h3><p><code>.spec.selector</code> 字段是一个标签选择器。ReplicationController 管理所有标签与选择器匹配的 Pod 。它不区分pod是某人或某个进程创建或删除的。这允许更换 ReplicationController 而不影响正在运行的 pod。</p>
<p>如果指定 <code>selector</code>，<code>.spec.template.metadata.labels</code> 必须与 <code>.spec.selector</code> 相同，否则将被API拒绝。如果 <code>.spec.selector</code> 未指定，则将默认为 <code>.spec.template.metadata.labels</code>。</p>
<p>另外，您不能直接通过另一个 ReplicationController 或另一个类似于 Job 的 controller 来创建与这个 labels 相同 selector 的 pod。 否则， ReplicationController 会认为这些 pod 是由它创建的。Kubernetes 不会阻止你这样做。</p>
<p>如果最终使用具有相同 selector 的多个 controller ，则必须自己去删除。</p>
<h3 id="Replicas"><a href="#Replicas" class="headerlink" title="Replicas"></a>Replicas</h3><p>您可以设置 <code>.spec.replicas</code> 来指定您想要同时运行的 pod 数量。有时候运行的数量可能会更高或更低，例如副本刚刚增加或减少，或者如果一个容器正常关机，并且提前开始更换。</p>
<p>如果您没有指定<code>.spec.replicas</code>的数量, 默认值是1</p>
<h2 id="使用-ReplicationController"><a href="#使用-ReplicationController" class="headerlink" title="使用 ReplicationController"></a>使用 ReplicationController</h2><h3 id="创建-Pod"><a href="#创建-Pod" class="headerlink" title="创建 Pod"></a>创建 Pod</h3><p>这是一个 ReplicationController 配置示例。它运行3个 nginx Web 服务副本。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF&gt; replication.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ReplicationController</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: nginx</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">EOF</span><br><span class="line">kubectl create -f replication.yaml</span><br></pre></td></tr></table></figure>
<p>查看 replicationcontroller 状态<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@kubernetes ~]# kubectl describe replicationcontroller nginx</span><br><span class="line">...</span><br><span class="line">  Normal  SuccessfulCreate  4m    replication-controller  Created pod: nginx-4tdl7</span><br><span class="line">  Normal  SuccessfulCreate  4m    replication-controller  Created pod: nginx-qrpdw</span><br><span class="line">  Normal  SuccessfulCreate  4m    replication-controller  Created pod: nginx-9wcf2</span><br></pre></td></tr></table></figure></p>
<p>可以使用如下命令列出属于 rc 的所有 pod ：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods --selector=app=nginx --output=jsonpath=&#123;.items..metadata.name&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="删除-ReplicationController-和-Pod"><a href="#删除-ReplicationController-和-Pod" class="headerlink" title="删除 ReplicationController 和 Pod"></a>删除 ReplicationController 和 Pod</h3><p>使用以下命令删除 ReplicationController nginx  及其它的所有 pod，在删除 ReplicationController 本身之前， Kubectl 会将 ReplicationController 缩容为零并等待它删除完 pod 。 如果 kubectl 命令被中断，它会被重启。</p>
<blockquote>
<p>注意:当使用 REST API 或 go 客户端库时，您需要明确地执行这些步骤（将 replicas 缩容为 0，等待 pod 删除，然后删除 ReplicationController ）。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl  delete  replicationcontroller nginx</span><br></pre></td></tr></table></figure>
<h3 id="只删除-ReplicationController"><a href="#只删除-ReplicationController" class="headerlink" title="只删除 ReplicationController"></a>只删除 ReplicationController</h3><p>使用 kubectl ，为 <code>kubectl delete</code>指定 <code>--cascade=false</code> 选项。<br>使用 REST API 或go 客户端库时，只需删除 ReplicationController 对象即可。<br>当原始的 ReplicationController 被删除后，您可以创建一个新的 ReplicationController 来替换它。 只要旧的和新的 <code>.spec.selector</code> 是一样的，那么新的 ReplicationController 将会接管旧的 pod 。 但是，在不同 pod template 的情况下，现有的 pod 是不会去匹配新的 template 。 使用 <code>rolling update</code> 以可控的方式将 pod 更新为新的 spec 。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl  delete --cascade=false replicationcontroller nginx</span><br></pre></td></tr></table></figure></p>
<h3 id="重新调度"><a href="#重新调度" class="headerlink" title="重新调度"></a>重新调度</h3><p>无论您是要运行1个 pod 还是1000个， ReplicationController 将保持指定数量的 pod 存在，即使在节点故障或 pod 终止的情况下（例如，由于其他控制代理的操作）。</p>
<h3 id="扩容与缩容"><a href="#扩容与缩容" class="headerlink" title="扩容与缩容"></a>扩容与缩容</h3><p>通过简单地更新 replicas 字段， ReplicationController 可以自动扩容和缩容 replica 的数量。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale --replicas=1 rc/nginx</span><br></pre></td></tr></table></figure></p>
<h3 id="滚动更新"><a href="#滚动更新" class="headerlink" title="滚动更新"></a>滚动更新</h3><p>滚动升级在客户端工具中实现 <code>kubectl rolling-update</code>。</p>
<h3 id="多版本跟踪"><a href="#多版本跟踪" class="headerlink" title="多版本跟踪"></a>多版本跟踪</h3><p>例如，一个 service 可能会以 标签 <code>tier in (frontend), environment in (prod)</code> 指向所有的 pod 。加入你有10个 pod 的 replicas 组成了这一层。创建一个新的 <code>canary</code> 版本。您可以设置一个 ReplicationController ，replicas对于带有标签 <code>tier=frontend, environment=prod, track=stable</code>设置为9, 另一个 ReplicationController 的  replicas设置为 1 ，带有标签为 <code>tier=frontend, environment=prod, track=canary</code>。现在该 service 包括了金丝雀和非金丝雀 pod 。但是你可以单独使用ReplicationController来测试，监控结果等。</p>
<h3 id="使用-ReplicationControllers-与-Services"><a href="#使用-ReplicationControllers-与-Services" class="headerlink" title="使用 ReplicationControllers 与 Services"></a>使用 ReplicationControllers 与 Services</h3><p>一个 service 可以对应多个 ReplicationControllers ，比如，一些流量转到旧版本，一些转到新版本。</p>
<p>ReplicationController 永远不会自动终止，但不会像 service 一样长期存在。 service 可能由多个 ReplicationControllers 控制的 pod 组成，并且可能会在 service 的整个生命周期内可能会创建和销毁许多 ReplicationControllers （例如，执行运行该服务的 pod 的更新）。 不管是服务本身还是其客户端都应该为 ReplicationControllers 保留维护服务的pod。</p>
<h2 id="replication-的替代品"><a href="#replication-的替代品" class="headerlink" title="replication 的替代品"></a>replication 的替代品</h2><h3 id="ReplicaSet"><a href="#ReplicaSet" class="headerlink" title="ReplicaSet"></a>ReplicaSet</h3><p><code>ReplicaSet</code> 是支持新的基于集合的标签选择器的下一代 ReplicationController 。它主要被 <code>Deployment</code> 用作协调 pod 创建，删除和更新的机制。请注意，我们建议您使用 <code>deployment</code> 而不是直接使用 <code>replicaset</code>，除非您需要自定义更新业务流程或根本不需要更新。</p>
<h3 id="Deployment（推荐）"><a href="#Deployment（推荐）" class="headerlink" title="Deployment（推荐）"></a>Deployment（推荐）</h3><p><code>Deployment</code> 是一个更高级别的 API 对象，它更新 Pod 类似于 <code>ReplicaSet</code> 的 <code>kubectl rolling-update</code>方式。 如果您想要这种滚动更新功能，建议使用 <code>Deployments</code> ，因为与 <code>kubectl rolling-update</code> 不同，它是声明式的、服务器端的，并且还具有其他功能。</p>
<h3 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h3><p>使用 <code>Job</code> 代替 ReplicationController ，用于自己预计终止的 pod （即批处理作业）。</p>
<h3 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h3><p>使用 <code>DaemonSet</code> 代替 ReplicationController 来提供机器级功能，例如机器监控或机器日志记录。 这些 pod 的生命周期与机器生命周期绑在一起：这些 pod 会在其他 pod 启动之前启动，并且当机器准备重新启动/关闭时会安全的终止。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">kuops</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://kuops.com/2018/06/26/Kubernetes-资源对象之ReplicationController/">https://kuops.com/2018/06/26/Kubernetes-资源对象之ReplicationController/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://kuops.com" target="_blank">Kuops Blog</a>！</span></div></div><div class="post-meta__tag-list"></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/07/12/gcr.io-镜像同步至dockerhub/"><i class="fa fa-chevron-left">  </i><span>gcr.io-镜像同步至dockerhub</span></a></div><div class="next-post pull-right"><a href="/2018/06/22/Kubernetes-资源对象之ConfigMap/"><span>Kubernetes资源对象之ConfigMap</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://kuops.com/2018/06/26/Kubernetes-资源对象之ReplicationController/';
  this.page.identifier = '2018/06/26/Kubernetes-资源对象之ReplicationController/';
  this.page.title = 'Kubernetes-资源对象之ReplicationController';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'kuops-com' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2019 By kuops</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.4"></script><script src="/js/fancybox.js?version=1.5.4"></script><script src="/js/sidebar.js?version=1.5.4"></script><script src="/js/copy.js?version=1.5.4"></script><script src="/js/fireworks.js?version=1.5.4"></script><script src="/js/transition.js?version=1.5.4"></script><script src="/js/scroll.js?version=1.5.4"></script><script src="/js/head.js?version=1.5.4"></script></body></html>