<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="创建 Kubernetes 集群：配置 Master 组件"><meta name="keywords" content=""><meta name="author" content="kuops,undefined"><meta name="copyright" content="kuops"><title>创建 Kubernetes 集群：配置 Master 组件 | Kuops Blog</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.4"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  localSearch: undefined
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#使用二进制方式部署"><span class="toc-number">1.</span> <span class="toc-text">使用二进制方式部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#配置-Kube-apiserver"><span class="toc-number">1.1.</span> <span class="toc-text">配置 Kube-apiserver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kube-apiserver-部分启动参数说明"><span class="toc-number">1.2.</span> <span class="toc-text">Kube-apiserver 部分启动参数说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置-kube-controller-manager"><span class="toc-number">1.3.</span> <span class="toc-text">配置 kube-controller-manager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kube-apiserver-部分启动参数说明-1"><span class="toc-number">1.4.</span> <span class="toc-text">Kube-apiserver 部分启动参数说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置-kube-scheduler"><span class="toc-number">1.5.</span> <span class="toc-text">配置 kube-scheduler</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通过-static-pod-方式部署"><span class="toc-number">2.</span> <span class="toc-text">通过 static_pod 方式部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#部署-kube-apiserver"><span class="toc-number">2.1.</span> <span class="toc-text">部署 kube-apiserver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署-kube-controller-manager"><span class="toc-number">2.2.</span> <span class="toc-text">部署 kube-controller-manager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署-kube-scheduler"><span class="toc-number">2.3.</span> <span class="toc-text">部署 kube-scheduler</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#验证"><span class="toc-number">3.</span> <span class="toc-text">验证</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">kuops</div><div class="author-info__description text-center">巧者劳而智者忧，无能者无所求</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">36</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">5</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1529517901642&amp;di=5f7db410ab487b78dd0afc85bc246702&amp;imgtype=0&amp;src=http%3A%2F%2Fimg5.duitang.com%2Fuploads%2Fitem%2F201610%2F21%2F20161021234613_KvFXP.jpeg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Kuops Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">创建 Kubernetes 集群：配置 Master 组件</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-07-19</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/kubernetes/">kubernetes</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div id="post-content"><blockquote>
<p>本篇文章为创建 Kubernets 集群 <code>第六部分</code></p>
<ol>
<li><a href="https://kuops.com/2018/07/19/deploy-kubernets-ha-01/">环境准备</a></li>
<li><a href="https://kuops.com/2018/07/19/deploy-kubernets-ha-02/">生成证书</a></li>
<li><a href="https://kuops.com/2018/07/19/deploy-kubernets-ha-03/">生成kubeconfig</a></li>
<li><a href="https://kuops.com/2018/07/19/deploy-kubernets-ha-04/">配置 etcd 集群</a></li>
<li><a href="https://kuops.com/2018/07/19/deploy-kubernets-ha-05/">配置 HA</a></li>
<li><a href="https://kuops.com/2018/07/19/deploy-kubernets-ha-06/">配置 Master 组件</a></li>
<li><a href="https://kuops.com/2018/07/19/deploy-kubernets-ha-07/">配置 bootstrap</a></li>
<li><a href="https://kuops.com/2018/07/19/deploy-kubernets-ha-08/">配置 kubelet 组件</a></li>
<li><a href="https://kuops.com/2018/07/19/deploy-kubernets-ha-09/">配置 kube-proxy 组件</a></li>
<li><a href="https://kuops.com/2018/07/19/deploy-kubernets-ha-10/">配置 Flannel 和 CoreDNS</a></li>
<li><a href="https://kuops.com/2018/07/19/deploy-kubernets-ha-11/">配置 ipvs</a></li>
<li><a href="https://kuops.com/2018/07/19/deploy-kubernets-ha-12/">配置 traefik ingress</a></li>
<li><a href="https://kuops.com/2018/07/19/deploy-kubernets-ha-13/">配置 dashboard</a></li>
<li><a href="https://kuops.com/2018/07/19/deploy-kubernets-ha-14/">配置 promethus-opreater</a></li>
<li><a href="https://kuops.com/2018/07/19/deploy-kubernets-ha-15/">配置 EFK</a></li>
<li><a href="https://kuops.com/2018/07/19/deploy-kubernets-ha-16/">配置 Ceph 存储</a></li>
</ol>
</blockquote>
<h2 id="使用二进制方式部署"><a href="#使用二进制方式部署" class="headerlink" title="使用二进制方式部署"></a>使用二进制方式部署</h2><h3 id="配置-Kube-apiserver"><a href="#配置-Kube-apiserver" class="headerlink" title="配置 Kube-apiserver"></a>配置 Kube-apiserver</h3><p>替换 <code>NODE_IP</code> 为当前  master 节点 IP ，并启动 Kube-apiserver</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">NODE_IP=&quot;10.0.7.101&quot;</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF&gt; /usr/lib/systemd/system/kube-apiserver.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver \\</span><br><span class="line">  --authorization-mode=Node,RBAC \\</span><br><span class="line">  --enable-admission-plugins=Initializers,DefaultStorageClass,DefaultTolerationSeconds,LimitRanger,NamespaceLifecycle,NodeRestriction,PersistentVolumeClaimResize,ResourceQuota,ServiceAccount \\</span><br><span class="line">  --advertise-address=$&#123;NODE_IP&#125; \\</span><br><span class="line">  --bind-address=0.0.0.0 \\</span><br><span class="line">  --insecure-port=0 \\</span><br><span class="line">  --secure-port=6443 \\</span><br><span class="line">  --allow-privileged=true \\</span><br><span class="line">  --apiserver-count=3 \\</span><br><span class="line">  --audit-log-maxage=30 \\</span><br><span class="line">  --audit-log-maxbackup=3 \\</span><br><span class="line">  --audit-log-maxsize=100 \\</span><br><span class="line">  --audit-log-path=/var/log/audit.log \\</span><br><span class="line">  --enable-swagger-ui=true \\</span><br><span class="line">  --storage-backend=etcd3 \\</span><br><span class="line">  --etcd-cafile=/etc/kubernetes/pki/ca.crt \\</span><br><span class="line">  --etcd-certfile=/etc/kubernetes/pki/etcd-client.crt \\</span><br><span class="line">  --etcd-keyfile=/etc/kubernetes/pki/etcd-client.key \\</span><br><span class="line">  --etcd-servers=https://10.0.7.101:2379,https://10.0.7.102:2379,https://10.0.7.103:2379 \\</span><br><span class="line">  --event-ttl=1h \\</span><br><span class="line">  --enable-bootstrap-token-auth \\</span><br><span class="line">  --client-ca-file=/etc/kubernetes/pki/ca.crt \\</span><br><span class="line">  --kubelet-https \\</span><br><span class="line">  --kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt \\</span><br><span class="line">  --kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key \\</span><br><span class="line">  --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \\</span><br><span class="line">  --runtime-config=api/all \\</span><br><span class="line">  --service-cluster-ip-range=10.96.0.0/16 \\</span><br><span class="line">  --service-node-port-range=30000-32767 \\</span><br><span class="line">  --service-account-key-file=/etc/kubernetes/pki/sa.pub \\</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/pki/kube-apiserver.crt \\</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/pki/kube-apiserver.key \\</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt \\</span><br><span class="line">  --requestheader-username-headers=X-Remote-User \\</span><br><span class="line">  --requestheader-group-headers=X-Remote-Group \\</span><br><span class="line">  --requestheader-allowed-names=front-proxy-client \\</span><br><span class="line">  --requestheader-extra-headers-prefix=X-Remote-Extra- \\</span><br><span class="line">  --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.crt \\</span><br><span class="line">  --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client.key \\</span><br><span class="line">  --feature-gates=PodShareProcessNamespace=true \\</span><br><span class="line">  --v=2</span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kube-apiserver</span><br><span class="line">systemctl restart kube-apiserver</span><br><span class="line">systemctl status kube-apiserver -l</span><br></pre></td></tr></table></figure>
<h3 id="Kube-apiserver-部分启动参数说明"><a href="#Kube-apiserver-部分启动参数说明" class="headerlink" title="Kube-apiserver 部分启动参数说明"></a>Kube-apiserver 部分启动参数说明</h3><ul>
<li><p><code>--authorization-mode</code>: 在安全端口上执行授权的插件列表。以逗号分隔的列表：<code>AlwaysAllow</code>，<code>AlwaysDeny</code>，<code>ABAC</code>，<code>Webhook</code>，<code>RBAC</code>，<code>Node</code>。</p>
</li>
<li><p><code>--enable-admission</code>: 除了默认启用的插件之外，应该启用的插件插件。逗号分隔录取插件列表,关于列表推荐，可以根据版本，选择<a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/" target="_blank" rel="noopener">官方推荐列表</a>。</p>
</li>
<li><p><code>--advertise-address</code>: 用于向群集成员通告 apiserver 的 IP 地址。该地址必须可由群集的其余部分访问。如果为空，则使用 <code>--bind-address</code>。如果未指定 <code>--bind-address</code>，将使用主机的默认接口。</p>
</li>
<li><p><code>--insecure-port</code>: 非安全端口 (http),为 0 表示不启用非安全端口。</p>
</li>
<li><p><code>--secure-port</code>: 安全端口 (https)。</p>
</li>
<li><p><code>--allow-privileged</code>: 如果为 true，则允许特权容器。</p>
</li>
<li><p><code>--apiserver-count</code>: 群集中运行的 api-server 数量。</p>
</li>
<li><p><code>--audit-log-path</code>: 审计日志存放的地方。</p>
</li>
<li><p><code>--enable-swagger-ui</code>: 访问 swagger, url /swagger-ui/</p>
</li>
<li><p><code>--event-ttl</code>: 保留事件的时间</p>
</li>
<li><p><code>--enable-bootstrap-token-auth</code>: 允许在 <code>kube-system</code> 命名空间中允许 <code>bootstrap.kubernetes.io/token</code> 类型的 secret 用于TLS引导认证。</p>
</li>
<li><p><code>--client-ca-file</code>: 启用客户端证书认证，通过 CA证书与客户端证书的 CommonName（CN） 对应的标识进行身份验证。</p>
</li>
<li><p><code>--kubelet-https</code>: 使用 https 与 kubelet 进行通信。</p>
</li>
<li><p><code>--kubelet-preferred-address-types</code>: 用于 kubelet 连接的首选节点地址类型的列表。</p>
</li>
<li><p><code>--runtime-config=api/all</code>: 一组 key/value ，描述可以传递给 apiserver 的运行时配置。<code>&lt;group&gt;/&lt;version&gt;</code>密钥可用于打开/关闭特定的 api 版本。api/all 是控制所有 api 版本的特殊键。</p>
</li>
<li><p><code>--service-cluster-ip-range</code>: service 资源对象的 ip 的 CIDR。</p>
</li>
<li><p><code>--service-node-port-range</code>: NodePort 使用的端口范围。</p>
</li>
<li><p><code>--service-account-key-file</code>: 用于验证 ServiceAccount 令牌。如果未指定，则使用 <code>--tls-private-key-file</code>。必须在提供 <code>--service-account-signing-key</code> 时指定。</p>
</li>
<li><p><code>--feature-gates=PodShareProcessNamespace</code>: 配置 Pod 间进程共享</p>
</li>
</ul>
<h3 id="配置-kube-controller-manager"><a href="#配置-kube-controller-manager" class="headerlink" title="配置 kube-controller-manager"></a>配置 kube-controller-manager</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">cat&lt;&lt;EOF&gt; /usr/lib/systemd/system/kube-controller-manager.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-controller-manager \\</span><br><span class="line">  --allocate-node-cidrs=true \\</span><br><span class="line">  --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \\</span><br><span class="line">  --address=127.0.0.1 \\</span><br><span class="line">  --leader-elect=true \\</span><br><span class="line">  --service-account-private-key-file=/etc/kubernetes/pki/sa.key \\</span><br><span class="line">  --cluster-name=kubernetes \\</span><br><span class="line">  --cluster-cidr=10.244.0.0/16 \\</span><br><span class="line">  --service-cluster-ip-range=10.96.0.0/16 \\</span><br><span class="line">  --cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt \\</span><br><span class="line">  --cluster-signing-key-file=/etc/kubernetes/pki/ca.key \\</span><br><span class="line">  --root-ca-file=/etc/kubernetes/pki/ca.crt \\</span><br><span class="line">  --use-service-account-credentials=true \\</span><br><span class="line">  --controllers=*,bootstrapsigner,tokencleaner \\</span><br><span class="line">  --experimental-cluster-signing-duration=86700h \\</span><br><span class="line">  --feature-gates=RotateKubeletClientCertificate=true \\</span><br><span class="line">  --v=2</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kube-controller-manager</span><br><span class="line">systemctl restart kube-controller-manager</span><br><span class="line">systemctl status kube-controller-manager -l</span><br></pre></td></tr></table></figure>
<h3 id="Kube-apiserver-部分启动参数说明-1"><a href="#Kube-apiserver-部分启动参数说明-1" class="headerlink" title="Kube-apiserver 部分启动参数说明"></a>Kube-apiserver 部分启动参数说明</h3><ul>
<li><p><code>--allocate-node-cidrs</code>:leader-elect 是否为 Pod 分配 CIDR。</p>
</li>
<li><p><code>--leader-elect</code>: 用于选举领导者，在高可用时保证集群中只有一位领导者</p>
</li>
<li><p><code>service-account-private-key-file</code>: 用于生成 service account tokens.</p>
</li>
<li><p><code>--cluster-cidr</code>: 集群中 Pod 的 CIDR 范围</p>
</li>
<li><p><code>--controllers</code>： 要启用的控制器列表，默认为 bootstrapsigner，tokencleaner</p>
</li>
<li><p><code>--experimental-cluster-signing-duration</code>: 自动生成的证书有效期，默认 8670h</p>
</li>
<li><p><code>--feature-gates=RotateKubeletServerCertificate=true</code>：kublet 证书的自动更新</p>
</li>
</ul>
<h3 id="配置-kube-scheduler"><a href="#配置-kube-scheduler" class="headerlink" title="配置 kube-scheduler"></a>配置 kube-scheduler</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-scheduler \\</span><br><span class="line">  --leader-elect=true \\</span><br><span class="line">  --kubeconfig=/etc/kubernetes/scheduler.kubeconfig \\</span><br><span class="line">  --address=127.0.0.1 \\</span><br><span class="line">  --v=2</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kube-scheduler</span><br><span class="line">systemctl restart kube-scheduler</span><br><span class="line">systemctl status kube-scheduler -l</span><br></pre></td></tr></table></figure>
<h2 id="通过-static-pod-方式部署"><a href="#通过-static-pod-方式部署" class="headerlink" title="通过 static_pod 方式部署"></a>通过 static_pod 方式部署</h2><h3 id="部署-kube-apiserver"><a href="#部署-kube-apiserver" class="headerlink" title="部署 kube-apiserver"></a>部署 kube-apiserver</h3><p>替换 <code>NODE_IP</code> 为自己的 IP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">NODE_IP=&quot;10.0.7.101&quot;</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF&gt; /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    component: kube-apiserver</span><br><span class="line">    tier: control-plane</span><br><span class="line">  name: kube-apiserver</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - command:</span><br><span class="line">    - kube-apiserver </span><br><span class="line">    - --authorization-mode=Node,RBAC </span><br><span class="line">    - --enable-admission-plugins=Initializers,DefaultStorageClass,DefaultTolerationSeconds,LimitRanger,NamespaceLifecycle,NodeRestriction,PersistentVolumeClaimResize,ResourceQuota,ServiceAccount </span><br><span class="line">    - --advertise-address=$&#123;NODE_IP&#125; </span><br><span class="line">    - --bind-address=0.0.0.0 </span><br><span class="line">    - --insecure-port=0 </span><br><span class="line">    - --secure-port=6443 </span><br><span class="line">    - --allow-privileged=true </span><br><span class="line">    - --apiserver-count=3 </span><br><span class="line">    - --audit-log-maxage=30 </span><br><span class="line">    - --audit-log-maxbackup=3 </span><br><span class="line">    - --audit-log-maxsize=100 </span><br><span class="line">    - --audit-log-path=/var/log/audit.log </span><br><span class="line">    - --enable-swagger-ui=true </span><br><span class="line">    - --storage-backend=etcd3 </span><br><span class="line">    - --etcd-cafile=/etc/kubernetes/pki/ca.crt </span><br><span class="line">    - --etcd-certfile=/etc/kubernetes/pki/etcd-client.crt </span><br><span class="line">    - --etcd-keyfile=/etc/kubernetes/pki/etcd-client.key </span><br><span class="line">    - --etcd-servers=https://10.0.7.101:2379,https://10.0.7.102:2379,https://10.0.7.103:2379 </span><br><span class="line">    - --event-ttl=1h </span><br><span class="line">    - --enable-bootstrap-token-auth </span><br><span class="line">    - --client-ca-file=/etc/kubernetes/pki/ca.crt </span><br><span class="line">    - --kubelet-https </span><br><span class="line">    - --kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt </span><br><span class="line">    - --kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key </span><br><span class="line">    - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname </span><br><span class="line">    - --runtime-config=api/all </span><br><span class="line">    - --service-cluster-ip-range=10.96.0.0/16 </span><br><span class="line">    - --service-node-port-range=30000-32767 </span><br><span class="line">    - --service-account-key-file=/etc/kubernetes/pki/sa.pub </span><br><span class="line">    - --tls-cert-file=/etc/kubernetes/pki/kube-apiserver.crt </span><br><span class="line">    - --tls-private-key-file=/etc/kubernetes/pki/kube-apiserver.key </span><br><span class="line">    - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt</span><br><span class="line">    - --requestheader-username-headers=X-Remote-User</span><br><span class="line">    - --requestheader-group-headers=X-Remote-Group</span><br><span class="line">    - --requestheader-allowed-names=front-proxy-client</span><br><span class="line">    - --requestheader-extra-headers-prefix=X-Remote-Extra-</span><br><span class="line">    - --feature-gates=PodShareProcessNamespace=true</span><br><span class="line">    - --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.crt</span><br><span class="line">    - --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client.key</span><br><span class="line">    - --v=2</span><br><span class="line">    image: kuops/kube-apiserver-amd64:v1.11.0</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    livenessProbe:</span><br><span class="line">      failureThreshold: 8</span><br><span class="line">      httpGet:</span><br><span class="line">        host: $&#123;NODE_IP&#125;</span><br><span class="line">        path: /healthz</span><br><span class="line">        port: 6443</span><br><span class="line">        scheme: HTTPS</span><br><span class="line">      initialDelaySeconds: 15</span><br><span class="line">      timeoutSeconds: 15</span><br><span class="line">    name: kube-apiserver</span><br><span class="line">    resources:</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 250m</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - mountPath: /etc/kubernetes/pki</span><br><span class="line">      name: k8s-certs</span><br><span class="line">      readOnly: true</span><br><span class="line">    - mountPath: /etc/ssl/certs</span><br><span class="line">      name: ca-certs</span><br><span class="line">      readOnly: true</span><br><span class="line">    - mountPath: /etc/pki</span><br><span class="line">      name: etc-pki</span><br><span class="line">      readOnly: true</span><br><span class="line">  hostNetwork: true</span><br><span class="line">  priorityClassName: system-cluster-critical</span><br><span class="line">  volumes:</span><br><span class="line">  - hostPath:</span><br><span class="line">      path: /etc/kubernetes/pki</span><br><span class="line">      type: DirectoryOrCreate</span><br><span class="line">    name: k8s-certs</span><br><span class="line">  - hostPath:</span><br><span class="line">      path: /etc/ssl/certs</span><br><span class="line">      type: DirectoryOrCreate</span><br><span class="line">    name: ca-certs</span><br><span class="line">  - hostPath:</span><br><span class="line">      path: /etc/pki</span><br><span class="line">      type: DirectoryOrCreate</span><br><span class="line">    name: etc-pki</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h3 id="部署-kube-controller-manager"><a href="#部署-kube-controller-manager" class="headerlink" title="部署 kube-controller-manager"></a>部署 kube-controller-manager</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF&gt; /etc/kubernetes/manifests/kube-controller-manager.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    scheduler.alpha.kubernetes.io/critical-pod: &quot;&quot;</span><br><span class="line">  labels:</span><br><span class="line">    component: kube-controller-manager</span><br><span class="line">    tier: control-plane</span><br><span class="line">  name: kube-controller-manager</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - command:</span><br><span class="line">    - kube-controller-manager</span><br><span class="line">    - --allocate-node-cidrs=true</span><br><span class="line">    - --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line">    - --address=127.0.0.1</span><br><span class="line">    - --leader-elect=true</span><br><span class="line">    - --service-account-private-key-file=/etc/kubernetes/pki/sa.key</span><br><span class="line">    - --cluster-name=kubernetes</span><br><span class="line">    - --cluster-cidr=10.244.0.0/16</span><br><span class="line">    - --service-cluster-ip-range=10.96.0.0/16</span><br><span class="line">    - --cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt</span><br><span class="line">    - --cluster-signing-key-file=/etc/kubernetes/pki/ca.key</span><br><span class="line">    - --root-ca-file=/etc/kubernetes/pki/ca.crt</span><br><span class="line">    - --use-service-account-credentials=true</span><br><span class="line">    - --controllers=*,bootstrapsigner,tokencleaner</span><br><span class="line">    - --experimental-cluster-signing-duration=86700h</span><br><span class="line">    - --feature-gates=RotateKubeletClientCertificate=true</span><br><span class="line">    - --v=2</span><br><span class="line">    image: kuops/kube-controller-manager-amd64:v1.11.0</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    livenessProbe:</span><br><span class="line">      failureThreshold: 8</span><br><span class="line">      httpGet:</span><br><span class="line">        host: 127.0.0.1</span><br><span class="line">        path: /healthz</span><br><span class="line">        port: 10252</span><br><span class="line">        scheme: HTTP</span><br><span class="line">      initialDelaySeconds: 15</span><br><span class="line">      timeoutSeconds: 15</span><br><span class="line">    name: kube-controller-manager</span><br><span class="line">    resources:</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 200m</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - mountPath: /etc/kubernetes/pki</span><br><span class="line">      name: k8s-certs</span><br><span class="line">      readOnly: true</span><br><span class="line">    - mountPath: /etc/ssl/certs</span><br><span class="line">      name: ca-certs</span><br><span class="line">      readOnly: true</span><br><span class="line">    - mountPath: /etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line">      name: kubeconfig</span><br><span class="line">      readOnly: true</span><br><span class="line">    - mountPath: /usr/libexec/kubernetes/kubelet-plugins/volume/exec</span><br><span class="line">      name: flexvolume-dir</span><br><span class="line">    - mountPath: /etc/pki</span><br><span class="line">      name: etc-pki</span><br><span class="line">      readOnly: true</span><br><span class="line">  hostNetwork: true</span><br><span class="line">  priorityClassName: system-cluster-critical</span><br><span class="line">  volumes:</span><br><span class="line">  - hostPath:</span><br><span class="line">      path: /etc/kubernetes/pki</span><br><span class="line">      type: DirectoryOrCreate</span><br><span class="line">    name: k8s-certs</span><br><span class="line">  - hostPath:</span><br><span class="line">      path: /etc/ssl/certs</span><br><span class="line">      type: DirectoryOrCreate</span><br><span class="line">    name: ca-certs</span><br><span class="line">  - hostPath:</span><br><span class="line">      path: /etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line">      type: FileOrCreate</span><br><span class="line">    name: kubeconfig</span><br><span class="line">  - hostPath:</span><br><span class="line">      path: /usr/libexec/kubernetes/kubelet-plugins/volume/exec</span><br><span class="line">      type: DirectoryOrCreate</span><br><span class="line">    name: flexvolume-dir</span><br><span class="line">  - hostPath:</span><br><span class="line">      path: /etc/pki</span><br><span class="line">      type: DirectoryOrCreate</span><br><span class="line">    name: etc-pki</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h3 id="部署-kube-scheduler"><a href="#部署-kube-scheduler" class="headerlink" title="部署 kube-scheduler"></a>部署 kube-scheduler</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF&gt; /etc/kubernetes/manifests/kube-scheduler.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    component: kube-scheduler</span><br><span class="line">    tier: control-plane</span><br><span class="line">  name: kube-scheduler</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - command:</span><br><span class="line">    - kube-scheduler</span><br><span class="line">    - --address=127.0.0.1</span><br><span class="line">    - --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line">    - --leader-elect=true</span><br><span class="line">    - --v=2</span><br><span class="line">    image: kuops/kube-scheduler-amd64:v1.11.0</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    livenessProbe:</span><br><span class="line">      failureThreshold: 8</span><br><span class="line">      httpGet:</span><br><span class="line">        host: 127.0.0.1</span><br><span class="line">        path: /healthz</span><br><span class="line">        port: 10251</span><br><span class="line">        scheme: HTTP</span><br><span class="line">      initialDelaySeconds: 15</span><br><span class="line">      timeoutSeconds: 15</span><br><span class="line">    name: kube-scheduler</span><br><span class="line">    resources:</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 100m</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - mountPath: /etc/kubernetes/scheduler.kubeconfig</span><br><span class="line">      name: kubeconfig</span><br><span class="line">      readOnly: true</span><br><span class="line">  hostNetwork: true</span><br><span class="line">  priorityClassName: system-cluster-critical</span><br><span class="line">  volumes:</span><br><span class="line">  - hostPath:</span><br><span class="line">      path: /etc/kubernetes/scheduler.kubeconfig</span><br><span class="line">      type: FileOrCreate</span><br><span class="line">    name: kubeconfig</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>通过 kubectl 查看组件的健康状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 pki]# kubectl get cs</span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">controller-manager   Healthy   ok                   </span><br><span class="line">scheduler            Healthy   ok                   </span><br><span class="line">etcd-1               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">etcd-2               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;</span><br></pre></td></tr></table></figure>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">kuops</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://kuops.com/2018/07/19/deploy-kubernets-ha-06/">https://kuops.com/2018/07/19/deploy-kubernets-ha-06/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://kuops.com" target="_blank">Kuops Blog</a>！</span></div></div><div class="post-meta__tag-list"></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/07/19/deploy-kubernets-ha-05/"><i class="fa fa-chevron-left">  </i><span>创建 Kubernetes 集群：配置HA</span></a></div><div class="next-post pull-right"><a href="/2018/07/19/deploy-kubernets-ha-07/"><span>创建 Kubernetes 集群：配置 bootstrap</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://kuops.com/2018/07/19/deploy-kubernets-ha-06/';
  this.page.identifier = '2018/07/19/deploy-kubernets-ha-06/';
  this.page.title = '创建 Kubernetes 集群：配置 Master 组件';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'kuops-com' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2019 By kuops</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.4"></script><script src="/js/fancybox.js?version=1.5.4"></script><script src="/js/sidebar.js?version=1.5.4"></script><script src="/js/copy.js?version=1.5.4"></script><script src="/js/fireworks.js?version=1.5.4"></script><script src="/js/transition.js?version=1.5.4"></script><script src="/js/scroll.js?version=1.5.4"></script><script src="/js/head.js?version=1.5.4"></script></body></html>